# Methods

## Study Area

```{r nafo-strat,echo=F,fig.ncol=1,out.width="75%",fig.align="center",dpi=200,fig.cap = "NAFO divisions on the Scotian Shelf and the Southern Grand Banks. The 3NOPs4VWX5Zc Atlantic halibut stock survey area is denoted by the coloured area, with five area strata: 4X5YX (blues), 4W (oranges), 4V (purples), 3P (greens), and 3NO (reds), and three depth strata: 30 to 130 m (light colour), 131 to 250 m (medium colour), and 251 to 750 m (dark colour). NAFO subdivisions are labelled, and separated by solid lines. The exclusive economic zones of Canada and France are shown with dashed lines. NAFO subdivision 3Pn is not part of the stock area, but is currently included in the survey."}
knitr::include_graphics("SurveyStrata.pdf")
```

There are 2 Atlantic Halibut management units in Canada. The focus of this work is the Scotian Shelf and Southern Grand Banks management unit which encompasses the North Atlantic Fisheries Organization (NAFO) divisions 3NOPs4VWX5Zc. The other NAFO division 4RST encompasses the Gulf of St. Lawrence and will not be included in this analysis. The definition of these NAFO divisions is mostly based on tagging studies that showed Atlantic halibut moving throughout most of the Canadian North Atlantic [@DFO2021], which has been supported by recent genetic analysis [@Kess2021]. Halibut is caught throughout the management unit and on the tail of the Grand Banks outside of Canada's exclusive economic zone (EEZ), mostly along the continental shelf [@DFO2021], see Figure \@ref(fig:nafo-strat).

Due to the nature of spatial modelling and our desire to scale station-specific indices up to an overall index representing the whole area, the area modelled is bounded by the continental shelf (750 m contour) as shown in Figure \@ref(fig:nafo-strat). Since no survey ever extends outside of these edges and we do not wish to extrapolate outside the bounds of the observations, restricting our model to this area was determined to be appropriate.

## Survey designs

As mentioned previously, there are 2 surveys with different sampling designs contributing to this analysis: a survey that follows a fixed stations design (1998 to 2021), and a survey following a stratified random sampling design (2017 to 2021). 

### Fixed Stations Design

Initially, the formulation of this survey followed a stratified design with 222 fixed stations, where 30 were reserved for the 3NOPs subdivision [@DenHeyer2015]. The strata were defined based on observed halibut landings by trips between 1993 and 1997 using 3 categories: high catches (>250 kg), medium catches (50-249 kg) and low catches (<49 kg) with the number of planned stations proportionally allocated following a ratio of 5:7:10 for the low, medium, and high strata respectively [@Zwanenburg2000;@Zwanenburg2003;@DenHeyer2015;@Smith2016a]. Station coverage has been inconsistent over time as not all stations have been covered every year and new stations were added in the mid-2000s [@DenHeyer2015]. The number of fixed stations decreased to around ~100 per year in 2017 due to the implementation of a new stratified random survey. See Table \@ref(tab:stat-samp) for the number of stations sampled every year.

The survey fishing protocol was to set 1000 hooks (Mustad circle hooks #14 or greater) per station and soak for 10 hours between 4 am and noon. Variations in both number and size of hooks (size #16 hooks becoming more common later in the time series) did occur [@DenHeyer2015]. The start or end of the longline was supposed to be within 3 nautical miles of the station. Vessel and captain participation varied over time due to many different factors, with 66 different vessels sampling the fixed stations since 2000. The number of halibut (including sub-legal size fish) and non-target species were counted in each set.

```{r stat-samp, echo=F}
farble<-data.frame(Year=1998:2021,
                   'Fixed Stations'= c(174,166,216,190,199,188,215,164,163,241,281,205,215,217,217,233,232,232,227,98,100,98,99,98),
                   'Stratified Stations'= c(rep("N/A",19),141,150,123,148,131),
                   'Total Stations'= c(174,166,216,190,199,188,215,164,163,241,281,205,215,217,217,233,232,232,227,239,250,221,247,229))
colnames(farble)<-c("Year","Fixed Stations","Stratified Stations","Total Stations")
csasdown::csas_table(farble,booktab=T,escape=F,align="c",row.names = F, caption = "Number of successfully sampled stations by sampling design between 1998 and 2021.")

```

### Stratified Random Design

The survey follows a stratified random sampling design, where the strata are the 5 NAFO subdivisions (4X5YZ, 4W, 4V, 3P, 3NO) each with 3 depth strata (30-130 m, 131-250 m, 251-750 m) and includes 3Pn and some areas outside of Canada's EEZ, which were not part of the management unit [@Cox2018;@Luo2022]. The depth bounds (30-750 m) based on exploratory analyses of catch rates by depth from the fixed stations [@Cox2018], contained most of the survey sets as well as most of the Atlantic halibut habitat. Approximately 150 survey stations per year were randomly assigned to strata with the number in a given stratum proportional to its size [@Cox2018;@Luo2022]. The fishing protocol was similar to the fixed stations protocol but notably more strictly defined, with each set containing 1000 baited hooks (size #15 hooks) set for between 6 and 12 hours [@Luo2022]. 40 different vessels have participated in the stratified survey sampling design, with 19 of those also sampling some of the fixed stations at some point (meaning 21 vessels have only participated in the stratified random survey).

Unlike the fixed stations, the observers collecting the stratified random survey data also recorded hook condition data on a subset of hooks for each set. Based on a pilot study that aimed to calculate the quantity of hooks required to be broadly representative of the whole set [@Doherty2017], 10 samples of 30 hooks across the line were chosen for a total of 300 per 1000 hooks [@Luo2022]. Instead of simply counting the number of halibut (including sub-legal size fish) and non-target species caught, the condition of each hook (baited, unbaited, broken, missing) is also recorded for this subsample. See Table \@ref(tab:stat-samp) for the number of stations sampled every year.

## Model Formulation

### MEM

The original aim of the MEM was to account for hook competition in longline fishing as proposed by @Rothschild1967 and reformulated by @Etienne2013. There are two different formulations of the MEM, which will respectively be called the Full MEM and the Reduced MEM. 

The Reduced MEM allows for three possible outcomes for every hook following the summation $N_i = N_{B,i}+N_{T,i}+N_{NT,i}$, wherein the total number of hooks $N_i$ on a longline set $i$ is the sum of the number of hooks with non-target species $N_{NT,i}$, the number of hooks with target species $N_{T,i}$, and the number of hooks without any animals that are assumed to still be baited $N_{B,i}$. Assuming that the time to catch a target or non-target species follows independent exponential distributions with rates $\lambda_T$ and $\lambda_{NT}$, then the the vector $(N_{B,i},N_{T,i},N_{NT,i})$ follows a multinomial distribution [@Etienne2013;@Luo2020;@Luo2022]:

\begin{equation}
(N_{B,i},N_{T,i},N_{NT,i}) \sim \mathcal{M}(N_i,\alpha_i) \ \ where
\end{equation}
\begin{equation}
\alpha_i = (e^{-\lambda S_i},(1-e^{-\lambda S_i})\frac{\lambda_T}{\lambda},(1-e^{-\lambda S_i})\frac{\lambda_{NT}}{\lambda}),
\end{equation}

$S_i$ is the soak time of longline set $i$, and $\lambda = \lambda_T + \lambda_{NT}$. 

This formulation does not account for the condition of hooks that return without catching animals, as these are not guaranteed to still be baited. @Etienne2013 therefore reformulated this MEM into the Full MEM, wherein hooks can also come back unbaited (which includes broken or missing hooks). These empty hooks are assumed to come from interactions with animals, but due to identifiability concerns another assumption has to be made as to whether they are caused by target or non-target species [@Etienne2013]. Since the gear is more likely to be oriented towards catching target species and that non-target species are likely more abundant (encompassing many more species than just the main target), it seemed more reasonable to assume that empty or broken hooks were caused by non-target species [@Etienne2013;@Luo2022]. **Furthermore, while this is likely to lead to a negative bias in the estimated catch rates, it is the most conservative choice as it guarantees there will be no positive bias caused by the assumption of escapes only caused by target species or target and non-target species having the same probability of escape (see results when this assumption is made in Appendix B)**. This extra outcome is therefore added to the multinomial model, which now follows the following distribution:

\begin{equation}
(N_{B,i},N_{T,i},N_{NT,i},N_{E,i}) \sim \mathcal{M}(N_i,\alpha_i) \ \ where
\end{equation}
\begin{equation}
\alpha_i = (e^{-\lambda S_i},(1-e^{-\lambda S_i})\frac{\lambda_T}{\lambda},(1-e^{-\lambda S_i})\frac{\lambda_{NT}}{\lambda}(1-p_{NT}),(1-e^{-\lambda S_i})\frac{\lambda_{NT}p_{NT}}{\lambda}),
\end{equation}

$N_{E,i}$ is the number of empty hooks, and $p_{NT}$ is the probability of escape of non-target animals. In this formulation, $p_{NT}$ shows up in the calculation of $N_{NT,i}$, as it impacts the catch rates of non-target species. As this component is present in the Reduced MEM and those non-target species would be similarly able to escape as in the Full MEM, we modified the Reduced MEM so that the multinomial component $N_{NT,i}$ is obtained as $(1-e^{-\lambda S_i})\frac{\lambda_{NT}}{\lambda}(1-p_{NT})$. While it is unlikely that this version of the Reduced MEM can reliably estimate $p_{NT}$, it should be able to borrow the information from the Full MEM when both datasets are analyzed in the same framework.

### MEMSpa

While the MEM model achieved its goal of incorporating hook competition to improve estimates of catch rates, it did not account for spatial patterns in the survey data. Previous work [@Luo2020;@Luo2022] incorporated geostatistical approaches to modify both versions of the MEM through the use of Gaussian Random Fields (GRF). 

The observation level of this new MEMSpa remained almost the same as described in the previous section, but the rates $\lambda_T$ and $\lambda_{NT}$ were modified to incorporate the location of a given longline set $i$:

\begin{equation}
\lambda_{T,i} = exp(\beta_T+\omega_{T,i})
\end{equation}
\begin{equation}
\lambda_{NT,i} = exp(\beta_{NT}+\omega_{NT,i})
\end{equation}

where $\lambda_{T,i}$ and $\lambda_{NT,i}$ are the exponential rates for target and non-target species at the location of longline set $i$, $\beta_T$ and $\beta_{NT}$ are intercept parameters, and $\omega_{T,i}$ and $\omega_{NT,i}$ are the values of the underlying GRF. 

These modifications allow the model to incorporate spatial patterns present in the data to obtain station-specific catch rates.An additional requirement is to be able to obtain a single overall estimated rate for the entire modelled area to be treated as an index of relative abundance. Due to the computational load of utilizing kriging to obtain this index, a Dirichlet method is preferred wherein the modelled area is divided into disjoint tiles based on the survey station locations, and each station is associated with a specific region and assumed to be representative of it [@Luo2022]. One can then obtain a spatially-weighted survey index for the whole area as follows:

\begin{equation}
Overall Index = \frac{\sum_{i=1}^I A_i \hat{\lambda}_i}{\sum_{i=1}^I A_i}
\end{equation}

where $A_i$ is the area of the Dirichlet tile associated with station $i$, $\hat{\lambda}_i$ is the corresponding estimated catch rate at this station, and $I$ is the total number of stations.

As the data from the stratified random survey only has a subset of its hooks where the hook condition was recorded, a product likelihood approach was taken so as to incorporate all the available data inside a unified framework. This consists of separately fitting the Reduced MEMSpa to the data without hook condition and the Full MEMSpa to the data with hook condition, and multiplying their likelihoods together (see @Luo2022 for more details on MEMSpa).

### Spatio-Temporal MEM

The improvements brought forward by the inclusion of spatial patterns in MEMSpa were very clear when fitted to the stratified dataset using the product likelihood method to combine both the 300 and 700 hook subsets, but there still remained years of available information from the fixed stations that had not been analyzed. Furthermore, MEMSpa could only be fit to a single year's data at a time and hence did not account for any temporal patterns in halibut or non-target species distributions and abundance. Incorporating the spatio-temporal variability in catches in the MEMSpa would result in a fully spatio-temporal MEM.

As we aim to retain the inclusion of spatial patterns through the residual structure as done in MEMSpa, we chose to incorporate the temporal aspects in the mean structure. There are many different approaches for incorporating temporal patterns in the mean and these usually involve random effects, with common approaches including random intercepts [@Venables2004;@Kai2017;@Pedersen2018], random slopes [@Venables2004;@Swain2009], random walks [@Swain2009;@Li2019], or autoregressive models [@Schnute1995;@Kai2017]. These last two could also be seen as more structured versions of other approaches wherein the random walk or autoregressive structure would be on the random intercept. Furthermore, we also decided to account for variability among different survey vessels by including random vessel effects. **While it is likely that there will be some confounding between vessel effects (for some vessels restricted to specific years or areas) and spatial and temporal effects, including them should still help separate the impact of most vessels from the effects of interest**. The novel formulation takes the following form:

\begin{equation}\label{eq:rand-int}
\lambda_{T,i,y} = exp(\eta_{T,y}+ \nu_{T,j}+\omega_{T,i,y})
\end{equation}
\begin{equation}\label{eq:rand-slope}
\lambda_{T,i,y} = exp(\beta_T+\eta_{T,y}+ \nu_{T,j}+\omega_{T,i,y})
\end{equation}

where $\lambda_{T,i,y}$ is the exponential rate for the target species at station $i$ in year $y$, $\nu_{T,j}$ is the random effect of vessel $j$ ($\nu_{T,j} \sim N(0,\sigma_\nu^2)$), $\eta_{T,y}$ is the random intercept for target species in year $y$ or, in Equation \@ref(eq:rand-slope), the random slope in year $y$ with global intercept $\beta_T$. $\omega_{T,i,y}$ are the GRF values for target species at station $i$ in year $y$. In Equation \@ref(eq:rand-int), $\eta_{T,y} \sim N(\mu_{T,int},\sigma_{T,int}^2)$, while for Equation \@ref(eq:rand-slope) $\mu_{T,int}=0$. For the random walk and autoregressive models, they follow the same formulation as Equation \@ref(eq:rand-int) with the following added structure on $\eta_{T,y}$:

\begin{equation}\label{eq:rand-walk}
\eta_{T,y} = \eta_{T,y-1} + \epsilon_y, \ \ \ \epsilon_y ~ N(0,\sigma_\eta^2)
\end{equation}
\begin{equation}\label{eq:ar1}
\eta_{T,y} = c + \phi \eta_{T,y-1} + \epsilon_y, \ \ \ \epsilon_y ~ N(0,\sigma_\eta^2)
\end{equation}

where $\epsilon_y$ is an error term ($\epsilon_y \sim N(0,\sigma_\eta^2)$). The autoregressive model in Equation \@ref(eq:ar1) is a first order autoregressive (AR(1)) process with constant mean $c$ and autoregressive parameter $\phi$ bounded between -1 and 1 to ensure stationarity. Non-target rates follow the same structure as above with non-target specific parameters. 

**These models are fit to the data from both surveys. As the fixed stations data do not contain any information on hook condition, only the Reduced MEM can be fit to it. Model selection will be done by comparing root mean squared errors (RMSE), and by calculating AIC and BIC values for the 4 different model fits to every data subsets examined. These subset include the following: the stratified data (2017 to 2020), the fixed stations (1998 to 2020), both datasets in overlapping years (2017 to 2020) and both datasets for all years (1998 to 2020).** There are 2 types of errors to consider in this model, one being the GRF at the hierarchical level of the catch rates $\lambda$ and the other being the difference between the observations and the expected observations based on the probabilities obtained from the multinomial distribution. Either way, the RMSE is calculated as:

\begin{equation}
RMSE = \sqrt{\frac{\sum_{i=1}^N e_i^2}{N}}
\end{equation}

where $e_i$ is the error, either the GRF value $\omega_{i,y}$ for rate $i$ in year $y$ or the total difference between the observed and expected value of target, non-target and hooks for a given longline set $i$.

AIC [@Akaike1974] and BIC [@Schwarz1978] are both information criterion that are used to compare different models fit to the same data and try to balance between better model fit (through higher likelihood) and number of parameters. They are respectively calculated as:

\begin{equation}\label{eq:aic}
AIC = 2K - 2 log(L)
\end{equation}
\begin{equation}\label{eq:bic}
BIC = K log(n) - 2 log(L)
\end{equation}

where $K$ is the number of parameters, $log(\cdot)$ is the natural log, $L$ is the maximized likelihood, and $n$ is the number of data points.

**Using the best model identified for the fit with both datasets from 2000 to 2021, a 10-fold cross-validation is performed to test the predictive ability of this model. This means that both datasets are split into 2 portions containing 90% (training set) and 10% (test set) of the data each. The model is then fit to the training set to estimate parameters and predict random effects, after which the model output is used to predict the data from the test set. Ordinary kriging is used to obtain the GRF values at the locations of the test sets. The differences between the predictions of the test sets and the actual observations can then be observed using out-of-sample RMSE calculated as before.**

## Data

Models were fit to different data subset: the stratified data (2017 to 2020), the fixed stations (1998 to 2020), both datasets in overlapping years (2017 to 2020) and both datasets for all years (1998 to 2020). For comparative purposes, the nominal catch rate in each year is calculated by dividing the observed number of halibuts caught at each station by the product of the number of hooks and the soak time of each station. This was done separately for both datasets combined and for the fixed station dataset. Code used to analyze the data is available at https://github.com/RaphMcDo/TechRepMEM/tree/master/Analysis%20Scripts.

## Persistence of spatial patterns

The ability of the fixed stations data to accurately capture changes in the relative abundance of Atlantic halibut and non-target species abundance was explored. Generally, obtaining an unbiased estimate of population abundance when only using fixed stations is very difficult due to the absence of reliable design-based estimators [@Li2015;@Lee2018]. Furthermore, an underlying assumption of a fixed station survey design is that the spatial distribution of the population of interest is consistent over time [@Li2015;@Lee2018], **as changes in this spatial distribution would lower the ability of this design to track changes over time and reduce the efficiency of the strata used for the original choice of stations**. In our case, this means that the distribution of Atlantic halibut and non-target species would have to be consistent with their spatial distribution between 1995 and 1997. The fixed stations design was able to detect changes in abundance [@Trzcinski2016;@DenHeyer2015;@Li2022], but there was concern that catch rates might not be proportional to abundance [@Smith2016a;@Cox2018]. As this stock recovered, the distribution of the commercial fishery changed and expanded [@DenHeyer2015;@Li2022], highlighting the need for survey coverage throughout the management unit.

A relatively straightforward approach to test the fixed stations for their ability to appropriately track population abundance change over time is test the persistence of these distributions over time [@Lee2018]. Given that the counts transformed to catch rates violated the basic assumptions of the traditional ANOVA approach chosen by @Lee2018 **(as our data was not normally distributed)**, we evaluated persistence by conducting a series of pairwise comparisons of halibut and non-target species catch rates between years. The statistic was calculated as follow [@Warren1994;@Li2015]: 

\begin{equation}
\bar{\omega} = \frac{s^2_y/4}{s^2_s-s^2_y/4}
\end{equation}

where $\bar{\omega}$ is the measurement of the degree of persistence where a smaller value indicates a greater degree of persistence, $s^2_y$ is the difference in catch rates of the same site between compared years, and $s^2_s$ is the difference in catch rates between different sites in the same year. These last 2 variables are calculated as:

\begin{equation}
s^2_s = \frac{\sum_{y=1}^2 \sum_{y=1}^{n_i} (x_{iy}-\bar{x}_y)^2}{m_1+m_2-2}
\end{equation}
\begin{equation}
s^2_y = \sum_{i=1}^m (d_i - \bar{d})^2 / (m-1)
\end{equation}

where $x_{iy}$ is the observed catch rate in site $i$ and year $y$, $\bar{x}_y$ is the mean observed catch rate of year $y$, $m_1$ is the number of fixed stations in the first year included in the pairwise comparison while $m_2$ is the same for the second year, $d_i$ is the difference in catch rate between two years in site $i$ and $\bar{d}$ is the mean catch rate difference. An important note here is that, as the coverage of stations changed over time, there are often more stations included in the $s^2_s$ than $s^2_y$ as all stations in both years are included in $s^2_s$, but only the stations fished in both years can be included in $s^2_y$. **Since no p-values are used in this approach, no explicit multiple comparison corrections (e.g., Bonferonni correction) can be performed, but the large number of pairwise comparisons should temper any conclusions drawn from this analysis. Furthermore, this short analysis is meant as a quick exploration to help identify potential reasons why the Spatio-Temporal MEM might identify different patterns when fit to both datasets or just the fixed station data.**
